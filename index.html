<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Last Fm Statistics</title>
    <script type="text/javascript" src="lastfm.api.md5.js"></script>
    <script type="text/javascript" src="lastfm.api.js"></script>
    <script type="text/javascript" src="lastfm.api.cache.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>
    <style>
        canvas {
            width: 50%;
            height: 400px;
            position: relative;
            float: left;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <div id="content">
        <canvas id="tagsChart"></canvas>
        <canvas id="albumsChart"></canvas>
        <canvas id="tracksChart"></canvas>
        <canvas id="rankingsChart"></canvas>
    </div>
</div>
<script>
    //cache
    var cache = new LastFMCache();
    //create charts
    var tagsChart = document.getElementById("tagsChart");
    var albumsChart = document.getElementById("albumsChart");
    var tracksChart = document.getElementById("tracksChart");
    var rankingsChart = document.getElementById("rankingsChart");


    function buildGenres(chart, labels, data) {
	    var tagsChart = new Chart(chart, {
	        type: 'radar',
	        data: {
	            labels: labels,
	            datasets: [
	                {
	                    label: "Yoann303 dataset",
	                    data: data,
                        borderColor: [
                            'rgba(33,33,33,1)'
                        ],
                        backgroundColor: [
                            'rgba(33,33,33,0.7)'
                        ],
                        borderWidth: 1,
                        pointRadius: 0
	                }
	            ]
	        },
            options: {
                responsive: false,
                scale: {
                    ticks: {
                        display: false,
                        beginAtZero: true,
                        min: 0,
                        max: 5,
                        stepSize: 5
                    }
                }
            }
	    });
    }
    //create lastfm object
    var lastfm = new LastFM({
        apiKey: '76305a32595a40f5d298af26c890a9b9',
        apiSecret: '629f12eb1d53f50c80d4688192db2d15',
        cache: cache
    });

    var loved_albums;
    var top_tag;
    var tags;
    var genres = [];
    var values = [];
    var top_tag_index = 0;

    var limit = 5;

    //get top albums and use this data for genres afterwards
    document.addEventListener('DOMContentLoaded', function () {
        lastfm.user.getTopAlbums({user: 'yoann303', period: '7day', limit: limit}, {
            success: function (data) {
                loved_albums = data.topalbums.album;
            }, error: function (code, message) {
                console.log(message);
            }
        });
    });
    
    var checkLovedAlbums = setInterval(isLovedAlbums, 200);

    function isLovedAlbums() {
        if(loved_albums != undefined) {
            clearInterval(checkLovedAlbums);
            storeTopTags();
        }
    }

    function storeTopTags() {
        //get top tags
        for (var i = 0; i < limit; i++) (function (i) {
            lastfm.album.getTopTags({artist: loved_albums[i].artist.name, album: loved_albums[i]['name']}, {
                success: function (data) {
                    try {
                        tags = data.toptags.tag;
                        //usually first tag is the release year so I'm adding this to pass through that
                        //although in needs more work after I run some tests.
                        for(var j = 0; j < tags.length; j++) {
                            if (!isNaN(tags[j].name))
                                continue;
                            else {
                                top_tag = tags[j].name;
                                break;
                            }
                        }
                        //TODO: genres repetition values
                        //add other validations like trimming to lowercase and some regex maybe? to match a certain numeber of matched cases.
                        if(genres.indexOf(top_tag) != -1) {
                            var increment_index = genres.indexOf(top_tag);
                            values[increment_index]++;
                        } else {
                            genres[top_tag_index] = top_tag;
                            values[top_tag_index] = 1;
                        }
                        top_tag_index++
                        //get the actual data
                        if(top_tag_index == loved_albums.length) {
                            genres = genres.filter(function(element) {
                                return element !== undefined;
                            });
                            values = values.filter(function(element) {
                                return element !== undefined;
                            });
                            buildGenres(tagsChart, genres, values);
                            //define a function outside and use it to populate the chart
                        }
                    } catch (error) {
                        console.log(error.message);
                    }
                }, error: function (code, message) {
                    console.log(code);
                }
            });
        }(i));
    }
</script>
</body>
</html>